<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Pairing Code â€” OurApp</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’œ</text></svg>" />
</head>
<body class="auth-page">

<!-- NAV -->
<nav class="auth-nav">
  <a href="index.html" class="nav-logo">OurApp ğŸ’œ</a>
  <div style="display:flex;gap:10px;align-items:center;">
    <span style="font-size:.875rem;color:var(--muted)">Logged in as <strong class="user-name" style="color:var(--dark)"></strong></span>
    <button onclick="App.logout()" class="btn btn-outline btn-sm">Log Out</button>
  </div>
</nav>

<!-- MAIN -->
<main class="auth-main">
  <div class="auth-card" style="max-width:520px;">

    <!-- Waiting state -->
    <div id="waitingState">
      <div class="auth-icon">ğŸ”—</div>
      <h2>Your pairing code</h2>
      <p class="auth-sub">
        Share your code <em>or</em> invite link with your partner so they can join you â€” from any device!
      </p>

      <!-- Firebase status badge -->
      <div id="dbStatus" style="display:none;margin-bottom:16px;padding:8px 14px;border-radius:100px;font-size:.8rem;font-weight:600;display:inline-flex;align-items:center;gap:6px;"></div>

      <!-- Animated code display -->
      <div id="codeDisplay" class="code-display" aria-label="Pairing code"></div>

      <!-- Copy code + regen -->
      <div class="code-actions" style="margin-bottom:8px;">
        <button id="copyCodeBtn" class="btn btn-outline btn-sm">ğŸ“‹ Copy Code</button>
        <button id="regenBtn" class="btn btn-sm" style="background:var(--grad-soft);color:var(--purple);border:1px solid var(--border);">ğŸ”„ New Code</button>
      </div>

      <!-- Invite link (the primary sharing method) -->
      <div style="background:var(--cream);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:20px;">
        <div style="font-size:.8rem;font-weight:700;color:var(--purple);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em;">âœ¨ Recommended: Share your invite link</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="inviteLinkInput" readonly style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:.75rem;color:var(--mid);background:var(--white);font-family:monospace;overflow:hidden;text-overflow:ellipsis;" />
          <button id="copyLinkBtn" class="btn btn-primary btn-sm" style="white-space:nowrap;flex-shrink:0;">ğŸ“¤ Copy Link</button>
        </div>
        <p style="font-size:.75rem;color:var(--muted);margin-top:8px;line-height:1.5;">
          Your partner opens this link â†’ code is pre-filled â†’ they just add their name and join. Works cross-device! ğŸŒ
        </p>
      </div>

      <!-- Waiting indicator -->
      <div style="text-align:center;margin-bottom:24px;">
        <div style="display:inline-flex;align-items:center;gap:10px;background:var(--grad-soft);border:1px solid var(--border);border-radius:100px;padding:10px 20px;font-size:.9rem;color:var(--purple);font-weight:600;">
          <span class="dot" style="background:var(--purple)"></span>
          Waiting for your partner to joinâ€¦
        </div>
        <p style="font-size:.8rem;color:var(--muted);margin-top:12px;">This page updates automatically when they connect ğŸ‰</p>
      </div>

      <div class="auth-divider"><span>Partner already has their own code?</span></div>

      <div style="text-align:center;">
        <p style="font-size:.9rem;color:var(--mid);margin-bottom:12px;">If your partner already has <em>their</em> code, enter it here instead:</p>
        <a href="join.html" class="btn btn-primary btn-block">ğŸ’œ Enter My Partner's Code</a>
      </div>
    </div>

    <!-- Paired state (shown when partner joins) -->
    <div id="pairedState" style="display:none;text-align:center;padding:12px 0;">
      <div style="font-size:4rem;margin-bottom:12px;animation:float 2s ease-in-out infinite;">ğŸ‰</div>
      <h2 style="font-family:'Playfair Display',serif;color:var(--dark);">You're paired!</h2>
      <p style="color:var(--mid);margin:8px 0 20px;font-size:.95rem;" id="pairedNameMsg"></p>
      <div style="width:100%;height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:16px;">
        <div id="pairProgressBar" style="height:100%;background:var(--grad);width:0%;transition:width 1.5s ease;border-radius:2px;"></div>
      </div>
      <p style="font-size:.85rem;color:var(--muted);">Taking you to your dashboardâ€¦</p>
    </div>

  </div>
</main>

<div id="toast" class="toast"></div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<!-- OurApp scripts -->
<script src="firebase-config.js"></script>
<script src="app.js"></script>
<script src="firebase-db.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    if (!App.requireUser()) return;
    if (App.isPaired()) { window.location.href = 'dashboard.html'; return; }

    const user = App.getUser();
    document.querySelectorAll('.user-name').forEach(el => el.textContent = user.name);

    // Show Firebase status badge
    const badge = document.getElementById('dbStatus');
    if (DB.isReady()) {
      badge.innerHTML = 'ğŸŸ¢ Connected to cloud â€” pairing works across devices!';
      badge.style.background = 'rgba(123,79,233,.08)';
      badge.style.color = 'var(--purple)';
      badge.style.border = '1px solid rgba(123,79,233,.2)';
      badge.style.display = 'inline-flex';
    } else {
      badge.innerHTML = 'âš ï¸ No cloud DB configured â€” same-device only (see firebase-config.js)';
      badge.style.background = 'rgba(255,107,138,.08)';
      badge.style.color = '#b00030';
      badge.style.border = '1px solid rgba(255,107,138,.3)';
      badge.style.display = 'inline-flex';
    }

    // Generate / retrieve pair code â€” SYNC so code shows immediately
    let pairData = App.getPair();
    if (!pairData) {
      const code = App.generateCode();
      pairData = { code, createdAt: Date.now() };
      App.save(App.KEYS.PAIR, pairData);
    }

    // Show code and invite link immediately (never blocked by async)
    displayCode(pairData.code);
    updateInviteLink(pairData.code, user);

    // Register to Firebase in background (non-blocking)
    DB.registerCode(pairData.code, user).catch(e => console.warn('[OurApp] registerCode:', e));

    // â”€â”€â”€ Copy code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('copyCodeBtn').addEventListener('click', () => {
      navigator.clipboard.writeText(pairData.code).then(() => {
        App.toast('Code copied! Share it with your partner ğŸ“‹', 'ğŸ“‹');
      }).catch(() => App.toast('Your code: ' + pairData.code, 'ğŸ”‘'));
    });

    // â”€â”€â”€ Copy invite link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('copyLinkBtn').addEventListener('click', () => {
      const link = document.getElementById('inviteLinkInput').value;
      navigator.clipboard.writeText(link).then(() => {
        App.toast('Invite link copied! Send it to your partner ğŸ‰', 'ğŸ”—');
      }).catch(() => App.toast('Copy the link from the text box!', 'ğŸ”—'));
    });

    // â”€â”€â”€ Regen code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('regenBtn').addEventListener('click', async () => {
      await DB.removeCode(pairData.code);
      const code = App.generateCode();
      pairData = { code, createdAt: Date.now() };
      App.save(App.KEYS.PAIR, pairData);
      await DB.registerCode(code, user);
      displayCode(code);
      updateInviteLink(code, user);
      App.toast('New code generated! ğŸ”„', 'ğŸ”„');
    });

    // â”€â”€â”€ Real-time listener (Firebase) / polling fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const unsubscribe = DB.onPartnerJoined(pairData.code, (partner) => {
      unsubscribe();
      App.save(App.KEYS.PARTNER, partner);
      App.save(App.KEYS.JOINED, Date.now());
      handlePaired(partner);
    });

    // â”€â”€â”€ BroadcastChannel: same-browser tab detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    try {
      const bc = new BroadcastChannel('ourapp_pair');
      bc.onmessage = (evt) => {
        if (evt.data?.type === 'PAIRED' && evt.data.code === pairData.code) {
          handlePaired(evt.data.partner);
        }
      };
    } catch(e) { /* not supported in all browsers */ }

    function handlePaired(partner) {
      if (!App.getPartner()) {
        App.save(App.KEYS.PARTNER, partner);
        App.save(App.KEYS.JOINED, Date.now());
      }
      document.getElementById('waitingState').style.display = 'none';
      const ps = document.getElementById('pairedState');
      ps.style.display = 'block';
      document.getElementById('pairedNameMsg').textContent =
        `${partner.name} just joined! Welcome, ${user.name} & ${partner.name}! ğŸ’œ`;
      setTimeout(() => document.getElementById('pairProgressBar').style.width = '100%', 100);
      setTimeout(() => window.location.href = 'dashboard.html', 2200);
    }
  });

  function displayCode(code) {
    const container = document.getElementById('codeDisplay');
    if (!container) return;
    container.innerHTML = '';
    code.split('').forEach((ch, i) => {
      const d = document.createElement('div');
      d.className = 'code-digit animate';
      d.textContent = ch;
      d.style.animationDelay = `${i * 80}ms`;
      container.appendChild(d);
    });
  }

  function updateInviteLink(code, user) {
    try {
      const hostData = { ...user, pairCode: code };
      const b64  = btoa(unescape(encodeURIComponent(JSON.stringify(hostData))));
      // Build join URL â€” use join.html so it works on GitHub Pages
      const path = window.location.pathname.replace(/pair(\.html)?(\?.*)?$/, '');
      const base = window.location.origin + path + 'join.html';
      const link = `${base}?invite=${b64}`;
      const input = document.getElementById('inviteLinkInput');
      if (input) input.value = link;
    } catch(e) {
      console.warn('[OurApp] updateInviteLink error:', e);
    }
  }
</script>
</body>
</html>
