<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Join Your Partner â€” OurApp</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’œ</text></svg>" />
</head>
<body class="auth-page">

<!-- NAV -->
<nav class="auth-nav">
  <a href="index.html" class="nav-logo">OurApp ğŸ’œ</a>
  <a href="index.html" class="btn btn-outline btn-sm">â† Back Home</a>
</nav>

<!-- MAIN -->
<main class="auth-main">
  <div class="auth-card" style="max-width:500px;">

    <!-- STEP 1: Enter code -->
    <div id="step1">
      <div class="auth-icon">ğŸ’œ</div>
      <h2>Join your partner</h2>
      <p class="auth-sub" id="step1Sub">
        Enter your partner's 6-character code below to pair up!
      </p>

      <!-- Invite preview (shown when arriving via link) -->
      <div id="invitePreview" style="display:none;margin-bottom:20px;padding:16px;background:var(--grad-soft);border-radius:14px;border:1px solid var(--border);text-align:center;">
        <div id="inviteAvatar" style="font-size:3rem;margin-bottom:6px;"></div>
        <div style="font-weight:700;font-size:1.1rem;color:var(--dark);" id="inviteHostName"></div>
        <div style="font-size:.85rem;color:var(--muted);margin-top:4px;">wants to pair with you on OurApp ğŸ’œ</div>
      </div>

      <div id="joinError"   class="alert alert-error"   style="display:none;"></div>
      <div id="joinSuccess" class="alert alert-success" style="display:none;"></div>

      <!-- 6-box code input -->
      <div class="code-input" aria-label="Enter 6-character pairing code">
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
        <input type="text" maxlength="1" inputmode="text" autocomplete="off" />
      </div>

      <p style="text-align:center;font-size:.8rem;color:var(--muted);margin-bottom:20px;">
        Tip: paste the full code at once ğŸ“‹ â€” or ask your partner to share their invite link instead.
      </p>

      <!-- Loading spinner (hidden) -->
      <div id="lookupSpinner" style="display:none;text-align:center;margin-bottom:16px;">
        <div style="display:inline-flex;align-items:center;gap:8px;color:var(--purple);font-size:.9rem;font-weight:600;">
          <span class="dot" style="background:var(--purple);"></span> Checking codeâ€¦
        </div>
      </div>

      <button id="step1Btn" class="btn btn-primary btn-block btn-lg">
        ğŸ’œ Next â€” Create My Profile
      </button>

      <div class="auth-link" style="margin-top:16px;">
        Already have a code? <a href="pair.html">â† View my own code</a>
      </div>
    </div>

    <!-- STEP 2: Create profile -->
    <div id="step2" style="display:none;">
      <div class="auth-icon" id="step2Icon">ğŸŒ¸</div>
      <h2 id="step2Title">Almost there!</h2>
      <p class="auth-sub" id="step2Sub">Create your profile to complete the pairing.</p>

      <div id="step2Error" class="alert alert-error" style="display:none;"></div>

      <div class="form-row">
        <div class="form-group">
          <label for="joinName">Your first name</label>
          <input type="text" id="joinName" placeholder="e.g. Jordan" maxlength="30" autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label for="joinEmoji">Your emoji</label>
          <select id="joinEmoji">
            <option value="ğŸŒŠ">ğŸŒŠ Wave</option>
            <option value="ğŸ˜Š">ğŸ˜Š Happy</option>
            <option value="ğŸŒ¸">ğŸŒ¸ Blossom</option>
            <option value="ğŸŒ™">ğŸŒ™ Moon</option>
            <option value="â­">â­ Star</option>
            <option value="ğŸ¦‹">ğŸ¦‹ Butterfly</option>
            <option value="ğŸŒº">ğŸŒº Hibiscus</option>
            <option value="ğŸ€">ğŸ€ Lucky</option>
            <option value="ğŸŒˆ">ğŸŒˆ Rainbow</option>
            <option value="ğŸ”¥">ğŸ”¥ Fire</option>
            <option value="ğŸ’«">ğŸ’« Sparkle</option>
            <option value="ğŸ¸">ğŸ¸ Guitar</option>
            <option value="ğŸŒ»">ğŸŒ» Sunflower</option>
            <option value="ğŸ¦">ğŸ¦ Lion</option>
          </select>
        </div>
      </div>

      <button id="step2Btn" class="btn btn-primary btn-block btn-lg">
        ğŸ’œ Pair Up!
      </button>
      <button id="backBtn" class="btn btn-outline btn-block" style="margin-top:10px;">
        â† Change Code
      </button>
    </div>

    <!-- STEP 3: Success -->
    <div id="step3" style="display:none;text-align:center;padding:20px 0;">
      <div style="font-size:4rem;animation:float 2s ease-in-out infinite;">ğŸ’œ</div>
      <h2 style="margin-top:16px;font-family:'Playfair Display',serif;">You're paired!</h2>
      <p style="color:var(--mid);margin:10px 0 20px;font-size:.95rem;" id="pairedMsg"></p>
      <div style="width:100%;height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:16px;">
        <div id="progressBar" style="height:100%;background:var(--grad);width:0%;transition:width 1.5s ease;border-radius:2px;"></div>
      </div>
      <p style="font-size:.85rem;color:var(--muted);">Taking you to your dashboardâ€¦</p>
    </div>

  </div>
</main>

<div id="toast" class="toast"></div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<!-- OurApp scripts -->
<script src="firebase-config.js"></script>
<script src="app.js"></script>
<script src="firebase-db.js"></script>

<script>
  // â”€â”€â”€ Read URL invite param â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const params    = new URLSearchParams(window.location.search);
  const inviteB64 = params.get('invite');
  let   hostData  = null;

  if (inviteB64) {
    try {
      hostData = JSON.parse(decodeURIComponent(escape(atob(inviteB64))));
    } catch(e) {
      try { hostData = JSON.parse(atob(inviteB64)); } catch(e2) { hostData = null; }
    }
  }

  // If already paired â†’ dashboard
  if (App.isPaired()) window.location.href = 'dashboard.html';

  // Show invite preview
  if (hostData) {
    document.getElementById('invitePreview').style.display = 'block';
    document.getElementById('inviteAvatar').textContent    = hostData.emoji || 'ğŸ’œ';
    document.getElementById('inviteHostName').textContent  = hostData.name  || 'Your partner';
    document.getElementById('step1Sub').textContent = `${hostData.name} sent you an invite â€” confirm the code and create your profile!`;

    // Pre-fill code boxes
    const code   = (hostData.pairCode || '').toUpperCase();
    const inputs = document.querySelectorAll('.code-input input');
    code.split('').forEach((ch, i) => { if (inputs[i]) inputs[i].value = ch; });
  }

  // â”€â”€â”€ Code input wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', () => {
    const inputs = document.querySelectorAll('.code-input input');

    inputs.forEach((inp, idx) => {
      inp.addEventListener('input', e => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (e.target.value && idx < inputs.length - 1) inputs[idx + 1].focus();
      });
      inp.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) inputs[idx - 1].focus();
      });
      inp.addEventListener('paste', e => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData)
          .getData('text').toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 6);
        text.split('').forEach((ch, i) => { if (inputs[i]) inputs[i].value = ch; });
        if (text.length === 6) inputs[Math.min(5, text.length - 1)].focus();
      });
    });

    if (!hostData) inputs[0]?.focus();

    // â”€â”€â”€ Step 1: Verify code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('step1Btn').addEventListener('click', async () => {
      const code    = getCode();
      const errEl   = document.getElementById('joinError');
      const spinner = document.getElementById('lookupSpinner');
      const btn     = document.getElementById('step1Btn');

      errEl.style.display = 'none';

      if (code.length < 6) {
        errEl.textContent = 'âŒ Please enter the full 6-character code.';
        errEl.style.display = 'flex';
        return;
      }

      // Show loading state
      btn.disabled = true;
      btn.textContent = 'â³ Checkingâ€¦';
      spinner.style.display = 'block';

      let entry = null;

      // 1. Try Firebase (cross-device)
      entry = await DB.lookupCode(code);

      // 2. If not in Firebase but we have invite data with matching code, use that
      if (!entry && hostData && (hostData.pairCode || '').toUpperCase() === code) {
        // Register host data into Firebase/localStorage for this session
        await DB.registerCode(code, hostData);
        entry = { ...hostData, pairCode: code };
      }

      // Reset loading state
      btn.disabled = false;
      btn.textContent = 'ğŸ’œ Next â€” Create My Profile';
      spinner.style.display = 'none';

      if (!entry) {
        errEl.textContent = 'âŒ Code not found. Ask your partner to share their invite link instead of just the code.';
        errEl.style.display = 'flex';
        return;
      }

      // Prevent self-pairing
      const me = App.getUser();
      if (me && entry.id === me.id) {
        errEl.textContent = "ğŸ˜… That's your own code! Share it with your partner.";
        errEl.style.display = 'flex';
        return;
      }

      // Advance to step 2
      document.getElementById('step1').style.display = 'none';
      const step2 = document.getElementById('step2');
      step2.style.display = 'block';
      step2._entry = entry;
      step2._code  = code;
      document.getElementById('step2Title').textContent = `Join ${entry.name}! ğŸ‰`;
      document.getElementById('step2Sub').textContent   =
        `You're pairing with ${entry.name}. Pick your name and emoji to complete the connection.`;
      document.getElementById('joinName').focus();
    });

    // â”€â”€â”€ Emoji preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const emojiSel = document.getElementById('joinEmoji');
    emojiSel.addEventListener('change', () => {
      document.getElementById('step2Icon').textContent = emojiSel.value;
    });

    // â”€â”€â”€ Back button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step1').style.display = 'block';
    });

    // â”€â”€â”€ Step 2: Create profile & complete pairing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('step2Btn').addEventListener('click', async () => {
      const step2  = document.getElementById('step2');
      const entry  = step2._entry;
      const code   = step2._code;
      const name   = document.getElementById('joinName').value.trim();
      const emoji  = document.getElementById('joinEmoji').value;
      const err2   = document.getElementById('step2Error');
      const btn2   = document.getElementById('step2Btn');

      if (!name) {
        err2.textContent = 'âŒ Please enter your first name.';
        err2.style.display = 'flex';
        return;
      }

      btn2.disabled = true;
      btn2.textContent = 'â³ Pairingâ€¦';

      // Clear old session data, create new profile
      localStorage.removeItem(App.KEYS.PAIR);
      localStorage.removeItem(App.KEYS.PARTNER);
      localStorage.removeItem(App.KEYS.JOINED);
      localStorage.removeItem(App.KEYS.ANSWERS);
      localStorage.removeItem(App.KEYS.STREAK);

      const me = { name, emoji, email: '', id: Date.now().toString(36) };
      App.saveUser(me);

      // Write to Firebase (so Person A gets notified in real-time)
      await DB.joinCode(code, me);

      // Store partner locally
      App.save(App.KEYS.PARTNER, entry);
      App.save(App.KEYS.JOINED, Date.now());

      // Notify same-browser tab (BroadcastChannel)
      try {
        new BroadcastChannel('ourapp_pair').postMessage({ type: 'PAIRED', partner: me, code });
      } catch(e) {}

      // Show success screen
      step2.style.display = 'none';
      const step3 = document.getElementById('step3');
      step3.style.display = 'block';
      document.getElementById('pairedMsg').textContent =
        `You and ${entry.name} are now paired on OurApp! ğŸ‰`;
      setTimeout(() => document.getElementById('progressBar').style.width = '100%', 100);
      setTimeout(() => window.location.href = 'dashboard.html', 2000);
    });
  });

  function getCode() {
    return Array.from(document.querySelectorAll('.code-input input'))
      .map(i => i.value).join('').toUpperCase();
  }
</script>
</body>
</html>
